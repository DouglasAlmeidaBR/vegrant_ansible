  webserver:
    hosts: 10.0.2.14
    user: testadmin
    sudo: yes

    tasks:
      - name: Push preseed file for debconf
        template:
          src=mysql_seed.j2
          dest=/root/mysql.seed

      - name: Preseed mysql file
        command: /usr/bin/debconf-set-selections /root/mysql.seed

      - name: Install server
        apt: pkg=mysql-server state=installed force=yes

      - name: Ensure MySQL daemon is running
        service: name=mysql state=started

      - name: Delete mysql.seed file
        command: /bin/rm /root/mysql.seed

      - name: Set my.cnf template
        template:
          src=my.cnf.j2
          dest=/etc/mysql/my.cnf
          owner=root mode=0644
        notify:
        - mysql-restart

      - name: Ensure python mysql is installed
        apt: pkg=python-mysqldb state=installed force=yes

      - name: Remove empty password users
        mysql_user: name='' password='' host=localhost priv=*.*:USAGE state=absent login_user=root login_password=teste123456

      - name: Remove the MySQL test database
        mysql_db: db=test state=absent login_user=root login_password=teste123456

  handlers:
    - name: mysql-start
      service: name=mysql start=started

    - name: mysql-restart
      service: name=mysql state=restarted

    - name: mysql-stop
      service: name=mysql state=stopped
